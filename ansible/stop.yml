---
- name: ArrÃªt complet SIT Inov
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    
  tasks:
    # ArrÃªt des processus Node.js
    - name: ArrÃªt des processus frontend
      shell: pkill -f "next" || true
      failed_when: false
      tags: stop

    - name: ArrÃªt des processus backend
      shell: pkill -f "nest" || true
      failed_when: false
      tags: stop

    - name: ArrÃªt des processus npm
      shell: pkill -f "npm.*dev" || true
      failed_when: false
      tags: stop

    # Nettoyage des ports
    - name: Nettoyage port 3000
      shell: lsof -ti:3000 | xargs kill -9 || true
      failed_when: false
      tags: cleanup

    - name: Nettoyage port 4000
      shell: lsof -ti:4000 | xargs kill -9 || true
      failed_when: false
      tags: cleanup

    # ArrÃªt des services Docker (pause, pas suppression)
    - name: ArrÃªt services Docker
      shell: docker compose stop
      args:
        chdir: "{{ project_dir }}"
      failed_when: false
      tags: docker

    # Nettoyage des logs
    - name: Nettoyage logs temporaires
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/backend.log
        - /tmp/frontend.log
      tags: cleanup

    # Confirmation
    - name: Confirmation arrÃªt
      debug:
        msg: |
          âœ… Application SIT Inov arrÃªtÃ©e avec succÃ¨s !
          
          ğŸ§¹ Nettoyage effectuÃ© :
          - Processus Node.js arrÃªtÃ©s
          - Ports 3000 et 4000 libÃ©rÃ©s
          - Services Docker mis en pause (donnÃ©es prÃ©servÃ©es)
          - Logs temporaires supprimÃ©s
          
          ğŸš€ RedÃ©marrage: ansible-playbook -i ansible/inventory.yml ansible/start.yml
      tags: summary
