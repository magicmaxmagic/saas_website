---
- name: D√©ploiement applications sans Docker
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    
  tasks:
    # Phase 1: V√©rifications syst√®me
    - name: V√©rification pr√©requis
      include_tasks: checks.yml
      tags: [checks]

    # Installation des d√©pendances backend
    - name: Installation d√©pendances backend
      npm:
        path: "{{ project_dir }}/apps/backend"
        state: present
        production: no

    # Installation des d√©pendances frontend
    - name: Installation d√©pendances frontend
      npm:
        path: "{{ project_dir }}/apps/frontend"
        state: present
        production: no

    # G√©n√©ration Prisma
    - name: G√©n√©ration Prisma
      command: npx prisma generate
      args:
        chdir: "{{ project_dir }}/apps/backend"

    # Build backend
    - name: Build backend
      command: npm run build
      args:
        chdir: "{{ project_dir }}/apps/backend"

    # Build frontend
    - name: Build frontend
      command: npm run build
      args:
        chdir: "{{ project_dir }}/apps/frontend"

    # D√©marrage backend en d√©veloppement
    - name: D√©marrage backend (d√©veloppement)
      command: npm run start:dev
      args:
        chdir: "{{ project_dir }}/apps/backend"
      async: 45
      poll: 0
      register: backend_job

    # D√©marrage frontend en d√©veloppement
    - name: D√©marrage frontend (d√©veloppement)
      command: npm run dev
      args:
        chdir: "{{ project_dir }}/apps/frontend"
      async: 45
      poll: 0
      register: frontend_job

    # Attente des services
    - name: Attente backend
      wait_for:
        port: 4000
        host: localhost
        timeout: 60

    - name: Attente frontend
      wait_for:
        port: 3000
        host: localhost
        timeout: 60

    # R√©sum√©
    - name: R√©sum√© du d√©ploiement
      debug:
        msg: |
          üöÄ Applications d√©ploy√©es en mode d√©veloppement !
          
          üåê Frontend : http://localhost:3000
          üîß Backend : http://localhost:4000
          
          üìù Note : Les applications tournent en mode d√©veloppement
          ‚ö†Ô∏è  Assurez-vous que PostgreSQL et Redis sont d√©j√† d√©marr√©s
          
          üìã Pour arr√™ter les applications :
          - Ctrl+C dans les terminaux
          - Ou utiliser : pkill -f "npm run"
