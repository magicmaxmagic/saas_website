---
- name: ArrÃªt automatique complet SIT Innovation
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    
  tasks:
    # ArrÃªt des services Node.js
    - name: ArrÃªt backend via PID
      shell: |
        if [ -f {{ project_dir }}/logs/backend.pid ]; then
          kill -TERM $(cat {{ project_dir }}/logs/backend.pid) 2>/dev/null || true
          rm -f {{ project_dir }}/logs/backend.pid
        fi
      failed_when: false

    - name: ArrÃªt frontend via PID
      shell: |
        if [ -f {{ project_dir }}/logs/frontend.pid ]; then
          kill -TERM $(cat {{ project_dir }}/logs/frontend.pid) 2>/dev/null || true
          rm -f {{ project_dir }}/logs/frontend.pid
        fi
      failed_when: false

    # ArrÃªt des processus sur les ports
    - name: ArrÃªt des processus sur port 4000
      shell: |
        for pid in $(lsof -ti :4000); do
          kill -TERM $pid 2>/dev/null || true
        done
      failed_when: false

    - name: ArrÃªt des processus sur port 3000
      shell: |
        for pid in $(lsof -ti :3000); do
          kill -TERM $pid 2>/dev/null || true
        done
      failed_when: false

    # ArrÃªt des services Docker (sans suppression des donnÃ©es)
    - name: ArrÃªt services Docker
      shell: docker compose stop
      args:
        chdir: "{{ project_dir }}"
      failed_when: false

    # VÃ©rification
    - name: VÃ©rification arrÃªt
      command: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: docker_status

    - name: VÃ©rification ports
      shell: |
        echo "Port 3000: $(lsof -ti :3000 | wc -l) processus"
        echo "Port 4000: $(lsof -ti :4000 | wc -l) processus"
      register: port_status

    - name: RÃ©sultat arrÃªt
      debug:
        msg: |
          ğŸ›‘ ArrÃªt automatique terminÃ©
          
          ğŸ³ Conteneurs Docker :
          {{ docker_status.stdout }}
          
          ğŸ”Œ Ã‰tat des ports :
          {{ port_status.stdout }}
          
          ğŸ’¾ Les donnÃ©es sont prÃ©servÃ©es
          
          ğŸ”„ Pour redÃ©marrer : ansible-playbook -i ansible/inventory.yml ansible/auto-start.yml
