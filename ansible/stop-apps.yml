---
- name: ArrÃªt des applications SIT Innovation (prÃ©servation des services Docker)
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    
  tasks:
    # ArrÃªt des applications Node.js uniquement
    - name: ArrÃªt des processus frontend
      shell: pkill -f "next" || true
      failed_when: false
      tags: stop

    - name: ArrÃªt des processus backend
      shell: pkill -f "nest" || true
      failed_when: false
      tags: stop

    - name: ArrÃªt des processus npm
      shell: pkill -f "npm.*dev" || true
      failed_when: false
      tags: stop

    # Nettoyage des ports
    - name: Nettoyage port 3000
      shell: lsof -ti:3000 | xargs kill -9 || true
      failed_when: false
      tags: cleanup

    - name: Nettoyage port 4000
      shell: lsof -ti:4000 | xargs kill -9 || true
      failed_when: false
      tags: cleanup

    # Nettoyage des logs
    - name: Nettoyage logs temporaires
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/backend.log
        - /tmp/frontend.log
      tags: cleanup

    # VÃ©rification des services Docker
    - name: VÃ©rification services Docker
      command: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: docker_status
      failed_when: false

    # Confirmation
    - name: Confirmation arrÃªt
      debug:
        msg: |
          âœ… Applications SIT Innovation arrÃªtÃ©es !
          
          ğŸ§¹ Nettoyage effectuÃ© :
          - Processus Node.js arrÃªtÃ©s
          - Ports 3000 et 4000 libÃ©rÃ©s
          - Logs temporaires supprimÃ©s
          
          ğŸ³ Services Docker prÃ©servÃ©s :
          {{ docker_status.stdout }}
          
          ğŸš€ RedÃ©marrage apps: ansible-playbook -i ansible/inventory.yml ansible/applications.yml
          ğŸ›‘ ArrÃªt complet: ./launch.sh stop
      tags: summary
