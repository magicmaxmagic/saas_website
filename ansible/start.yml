---
- name: Installation et dÃ©marrage complet SIT Inov
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    node_version: "20.x"
    
  tasks:
    - name: VÃ©rification Node.js
      command: node --version
      register: node_version_check
      failed_when: false
      changed_when: false
      
    - name: Affichage version Node.js
      debug:
        msg: "Node.js version: {{ node_version_check.stdout }}"

    - name: ArrÃªt des services Docker existants
      shell: docker compose down
      args:
        chdir: "{{ project_dir }}"
      failed_when: false
      tags: docker

    - name: DÃ©marrage PostgreSQL
      shell: docker compose up -d postgres
      args:
        chdir: "{{ project_dir }}"
      register: postgres_start_result
      failed_when: false
      tags: docker


    - name: Suppression des donnÃ©es Redis (reset local)
      shell: |
        echo "ğŸ§¹ Suppression des donnÃ©es Redis locales..."
        rm -rf {{ project_dir }}/redis-data/* || true
      args:
        chdir: "{{ project_dir }}"
      tags: docker

    - name: CrÃ©ation du dossier de log Redis si besoin
      file:
        path: "{{ project_dir }}/redis-data/redis"
        state: directory
        mode: '0777'
      tags: docker

    - name: Copie de la config redis.conf (logfile dÃ©sactivÃ©)
      copy:
        src: "{{ project_dir }}/redis.conf"
        dest: "{{ project_dir }}/redis-data/redis.conf"
        mode: '0644'
      tags: docker


    - name: Attente PostgreSQL
      shell: |
        echo "ğŸ˜ Attente de PostgreSQL..."
        sleep 5
        for i in {1..20}; do
          if docker exec prevent-postgres pg_isready -U postgres -d sit_inov_dev >/dev/null 2>&1; then
            echo "âœ… PostgreSQL prÃªt"
            exit 0
          fi
          echo "â³ Tentative $i/20..."
          sleep 2
        done
        echo "âš ï¸ PostgreSQL prend du temps, on continue..."
        exit 0
      register: postgres_wait_result
      failed_when: false
      tags: docker

    - name: ArrÃªt Redis existant
      shell: |
        docker stop redis || true
        docker rm redis || true
      tags: docker

    - name: DÃ©marrage Redis (sans config personnalisÃ©e)
      shell: |
        echo "ğŸ”´ DÃ©marrage Redis..."
        docker run -d --name redis --rm -p 6379:6379 redis:7-alpine redis-server --logfile ""
      register: redis_start_result
      failed_when: false
      tags: docker
    - name: Attente Redis
      shell: |
        echo "ğŸ”´ Attente de Redis..."
        sleep 5
        for i in {1..20}; do
          if docker exec redis redis-cli ping >/dev/null 2>&1; then
            echo "âœ… Redis prÃªt"
            exit 0
          fi
          echo "â³ Tentative $i/20..."
          sleep 2
        done
        echo "âŒ Redis ne dÃ©marre pas, vÃ©rifiez les logs avec 'docker logs redis'"
        exit 1
      register: redis_wait_result
      failed_when: redis_wait_result.rc != 0
      tags: docker

    - name: VÃ©rification services Docker
      shell: |
        echo "ğŸ“Š Ã‰tat des services Docker :"
        docker ps
        echo ""
        echo "ğŸ§ª Tests de connexion :"
        if docker exec prevent-postgres pg_isready -U postgres -d sit_inov_dev >/dev/null 2>&1; then
          echo "âœ… PostgreSQL : OK"
        else
          echo "âŒ PostgreSQL : ERREUR"
        fi
        if docker exec redis redis-cli ping >/dev/null 2>&1; then
          echo "âœ… Redis : OK"
        else
          echo "âŒ Redis : ERREUR"
        fi
      register: docker_status
      failed_when: false
      tags: docker

    - name: Affichage Ã©tat Docker
      debug:
        msg: "{{ docker_status.stdout }}"
      when: docker_status.stdout is defined

    - name: Installation dÃ©pendances backend
      shell: |
        echo "ğŸ“¦ Installation des dÃ©pendances backend..."
        cd {{ project_dir }}/apps/backend
        npm install
      register: backend_deps_result
      tags: install

    - name: GÃ©nÃ©ration client Prisma
      command: npm run db:generate
      args:
        chdir: "{{ project_dir }}/apps/backend"
      environment:
        DATABASE_URL: "postgresql://postgres:password@localhost:5432/sit_inov_dev"
      tags: database

    - name: DÃ©marrage backend
      shell: |
        pkill -f "nest start" || true
        pkill -f "nodemon" || true
        sleep 2
        mkdir -p {{ project_dir }}/logs
        cd {{ project_dir }}/apps/backend
        nohup npm run start:dev > {{ project_dir }}/logs/backend.log 2>&1 &
        echo $! > {{ project_dir }}/logs/backend.pid
        sleep 3
        echo "âœ… Backend dÃ©marrÃ©"
      environment:
        DATABASE_URL: "postgresql://postgres:password@localhost:5432/sit_inov_dev"
        JWT_SECRET: "your-secret-key-here"
        STRIPE_SECRET_KEY: "sk_test_your_stripe_secret_key_here"
        REDIS_URL: "redis://localhost:6379"
        VAULT_URL: "http://localhost:8200"
      register: backend_start_result
      tags: start

    - name: Attente du backend
      shell: |
        echo "ğŸš€ Attente du backend NestJS..."
        sleep 5
        for i in {1..20}; do
          if curl -s http://localhost:4000/api/v1/health >/dev/null 2>&1; then
            echo "âœ… Backend prÃªt sur http://localhost:4000"
            exit 0
          fi
          echo "â³ Tentative $i/20..."
          sleep 3
        done
        echo "âš ï¸ Backend pas encore prÃªt"
        exit 1
      register: backend_wait
      failed_when: false
      tags: start

    - name: Installation dÃ©pendances frontend
      shell: |
        echo "ğŸ“¦ Installation des dÃ©pendances frontend..."
        cd {{ project_dir }}/apps/frontend
        npm install
      register: frontend_deps_result
      tags: install

    - name: DÃ©marrage frontend
      shell: |
        pkill -f "next-server" || true
        pkill -f "next dev" || true
        sleep 2
        mkdir -p {{ project_dir }}/logs
        cd {{ project_dir }}/apps/frontend
        nohup npm run dev > {{ project_dir }}/logs/frontend.log 2>&1 &
        echo $! > {{ project_dir }}/logs/frontend.pid
        sleep 3
        echo "âœ… Frontend dÃ©marrÃ©"
      environment:
        NEXT_PUBLIC_API_URL: "http://localhost:4000"
        NEXT_PUBLIC_APP_URL: "http://localhost:3000"
        NEXTAUTH_URL: "http://localhost:3000"
        NEXTAUTH_SECRET: "dev_nextauth_secret"
      register: frontend_start_result
      tags: start

    - name: Attente du frontend
      shell: |
        echo "ğŸŒ Attente du frontend Next.js..."
        sleep 5
        for i in {1..20}; do
          if curl -s http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Frontend prÃªt sur http://localhost:3000"
            exit 0
          fi
          echo "â³ Tentative $i/20..."
          sleep 3
        done
        echo "âš ï¸ Frontend pas encore prÃªt"
        exit 1
      register: frontend_wait
      failed_when: false
      tags: start

    - name: RÃ©sumÃ© du dÃ©marrage
      debug:
        msg: |
          ğŸš€ Application SIT Innovation - Ã‰tat final
          
          ğŸŒ Services disponibles :
          - Frontend: http://localhost:3000 ({{ 'âœ… OK' if frontend_wait.rc == 0 else 'âš ï¸ VÃ‰RIFIER' }})
          - Backend: http://localhost:4000 ({{ 'âœ… OK' if backend_wait.rc == 0 else 'âš ï¸ VÃ‰RIFIER' }})
          - PostgreSQL: localhost:5432 ({{ 'âœ… OK' if postgres_wait_result.rc == 0 else 'âš ï¸ VÃ‰RIFIER' }})
          - Redis: localhost:6379 ({{ 'âœ… OK' if redis_wait_result.rc == 0 else 'âš ï¸ VÃ‰RIFIER' }})
          
          ğŸ“‹ Logs en temps rÃ©el :
          - Backend: tail -f {{ project_dir }}/logs/backend.log
          - Frontend: tail -f {{ project_dir }}/logs/frontend.log
          
          ğŸ› ï¸ Commandes utiles :
          - ArrÃªt sÃ©curisÃ©: ./launch.sh stop
          - Statut: ./launch.sh status
          - Logs: ./launch.sh logs
          - RedÃ©marrage: ./launch.sh restart
      tags: summary
