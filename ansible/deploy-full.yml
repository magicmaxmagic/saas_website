---
- name: D√©ploiement complet SIT Innovation
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    # Configuration du d√©ploiement
    deploy_vault: true              # D√©ployer Vault avec Ansible
    deploy_infrastructure: true     # D√©ployer PostgreSQL, Redis, Nginx
    deploy_applications: true       # D√©ployer Backend et Frontend
    skip_docker_checks: true        # Ignorer les v√©rifications Docker (suppos√© d√©j√† install√©)
    
  tasks:
    # Phase 1: V√©rifications syst√®me
    - name: V√©rification pr√©requis
      include_tasks: checks.yml
      tags: [checks]

    # Phase 2: Installation Vault
    - name: D√©ploiement Vault
      include_tasks: vault.yml
      when: deploy_vault | default(true)
      tags: [vault]

    # Phase 3: Services d'infrastructure
    - name: Services infrastructure
      include_tasks: infrastructure.yml
      when: deploy_infrastructure | default(true)
      tags: [infrastructure]

    # Phase 4: Applications
    - name: Applications
      include_tasks: applications.yml
      when: deploy_applications | default(true)
      tags: [applications]

    # Phase 5: V√©rifications finales
    - name: V√©rifications finales
      include_tasks: verify.yml
      tags: [verify]

    # R√©sum√© final
    - name: R√©sum√© du d√©ploiement
      debug:
        msg: |
          üöÄ D√©ploiement SIT Innovation termin√© !
          
          üîê Vault : {{ 'http://localhost:8200 (Token: myroot)' if deploy_vault else 'Non d√©ploy√©' }}
          üóÑÔ∏è PostgreSQL : {{ 'localhost:5432 (postgres/password)' if deploy_infrastructure else 'Non d√©ploy√©' }}
          üì¶ Redis : {{ 'localhost:6379' if deploy_infrastructure else 'Non d√©ploy√©' }}
          üåê Frontend : {{ 'http://localhost:3000' if deploy_applications else 'Non d√©ploy√©' }}
          üîß Backend : {{ 'http://localhost:4000' if deploy_applications else 'Non d√©ploy√©' }}
          
          üìã Commandes utiles :
          - Arr√™t: ansible-playbook -i ansible/inventory.yml ansible/stop.yml
          - Restart: ansible-playbook -i ansible/inventory.yml ansible/restart.yml
          - Logs: ansible-playbook -i ansible/inventory.yml ansible/logs.yml
          - Status: ansible-playbook -i ansible/inventory.yml ansible/status.yml
          
          üí° Configuration personnalis√©e :
          - Vault: {{ 'Activ√©' if deploy_vault else 'D√©sactiv√©' }}
          - Infrastructure: {{ 'Activ√©e' if deploy_infrastructure else 'D√©sactiv√©e' }}
          - Applications: {{ 'Activ√©es' if deploy_applications else 'D√©sactiv√©es' }}
