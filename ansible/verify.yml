---
# VÃ©rifications finales
# VÃ©rification des services Docker
- name: VÃ©rification conteneurs Docker
  command: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
  register: docker_status

# Tests de santÃ©
- name: Test Vault
  uri:
    url: http://localhost:8200/v1/sys/health
    method: GET
    timeout: 5
  register: vault_health
  failed_when: false

- name: Test PostgreSQL
  command: docker exec postgres pg_isready -U postgres
  register: postgres_health
  failed_when: false

- name: Test Redis
  command: docker exec redis redis-cli ping
  register: redis_health
  failed_when: false

- name: Test Backend
  uri:
    url: http://localhost:4000/health
    method: GET
    timeout: 5
  register: backend_health
  failed_when: false

- name: Test Frontend
  uri:
    url: http://localhost:3000
    method: GET
    timeout: 5
  register: frontend_health
  failed_when: false

- name: Test Nginx
  uri:
    url: http://localhost
    method: GET
    timeout: 5
  register: nginx_health
  failed_when: false

# Affichage des rÃ©sultats
- name: RÃ©sultats des tests
  debug:
    msg: |
      ğŸ” VÃ©rifications finales :
      
      ğŸ“Š Statut des services :
      - ğŸ” Vault: {{ 'OK' if vault_health.status == 200 else 'ERREUR' }}
      - ğŸ—„ï¸ PostgreSQL: {{ 'OK' if 'accepting connections' in postgres_health.stdout else 'ERREUR' }}
      - ğŸ“¦ Redis: {{ 'OK' if redis_health.stdout == 'PONG' else 'ERREUR' }}
      - ğŸ”§ Backend: {{ 'OK' if backend_health.status == 200 else 'ERREUR' }}
      - ğŸŒ Frontend: {{ 'OK' if frontend_health.status == 200 else 'ERREUR' }}
      - ğŸ”€ Nginx: {{ 'OK' if nginx_health.status == 200 else 'ERREUR' }}
      
      ğŸ³ Conteneurs Docker :
      {{ docker_status.stdout }}
      
      ğŸ”— URLs disponibles :
      - Application: http://localhost
      - Backend API: http://localhost:4000
      - Frontend: http://localhost:3000
      - Vault: http://localhost:8200
