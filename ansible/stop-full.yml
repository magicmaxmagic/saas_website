---
- name: ArrÃªt complet SIT Innovation
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    
  tasks:
    - name: Avertissement suppression des donnÃ©es
      debug:
        msg: |
          âš ï¸  ATTENTION : Cette opÃ©ration va SUPPRIMER TOUTES LES DONNÃ‰ES !
          
          Cette action va :
          - ArrÃªter et supprimer tous les conteneurs
          - Supprimer tous les volumes (donnÃ©es PostgreSQL, Vault, Redis)
          - Nettoyer les images, rÃ©seaux et conteneurs
          
          Si vous voulez seulement arrÃªter les services sans perdre les donnÃ©es,
          utilisez: ansible-playbook -i ansible/inventory.yml ansible/stop.yml

    - name: Pause de sÃ©curitÃ©
      pause:
        seconds: 5
        prompt: "Appuyez sur Ctrl+C pour annuler, ou attendez 5 secondes pour continuer"

    # ArrÃªt des services principaux
    - name: ArrÃªt et suppression services principaux
      shell: docker compose down -v
      args:
        chdir: "{{ project_dir }}"
      failed_when: false

    # ArrÃªt Vault
    - name: ArrÃªt et suppression Vault
      shell: docker compose down -v
      args:
        chdir: "{{ project_dir }}/ansible/vault-ansible"
      failed_when: false

    # Nettoyage conteneurs
    - name: Nettoyage conteneurs
      command: docker container prune -f
      failed_when: false

    # Nettoyage images
    - name: Nettoyage images
      command: docker image prune -f
      failed_when: false

    # Nettoyage volumes
    - name: Nettoyage volumes
      command: docker volume prune -f
      failed_when: false

    # Nettoyage rÃ©seau
    - name: Nettoyage rÃ©seau
      command: docker network prune -f
      failed_when: false

    # VÃ©rification
    - name: VÃ©rification arrÃªt
      command: docker ps -a --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: docker_status

    - name: RÃ©sultat arrÃªt
      debug:
        msg: |
          ğŸ›‘ ArrÃªt complet terminÃ© avec suppression des donnÃ©es
          
          ğŸ³ Conteneurs restants :
          {{ docker_status.stdout }}
          
          âš ï¸  TOUTES LES DONNÃ‰ES ONT Ã‰TÃ‰ SUPPRIMÃ‰ES
          
          ğŸ”„ Pour redÃ©marrer : ./launch.sh start
