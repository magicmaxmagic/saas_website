---
- name: ArrÃªt sÃ©curisÃ© SIT Innovation (prÃ©servation des donnÃ©es)
  hosts: localhost
  connection: local
  become: no
  vars:
    project_dir: "{{ ansible_env.PWD }}"
    
  tasks:
    # ArrÃªt des applications Node.js
    - name: ArrÃªt des processus frontend
      shell: pkill -f "next" || true
      failed_when: false
      tags: stop

    - name: ArrÃªt des processus backend
      shell: pkill -f "nest" || true
      failed_when: false
      tags: stop

    - name: ArrÃªt des processus npm
      shell: pkill -f "npm.*dev" || true
      failed_when: false
      tags: stop

    # Nettoyage des ports
    - name: Nettoyage port 3000
      shell: lsof -ti:3000 | xargs kill -9 || true
      failed_when: false
      tags: cleanup

    - name: Nettoyage port 4000
      shell: lsof -ti:4000 | xargs kill -9 || true
      failed_when: false
      tags: cleanup

    # ArrÃªt des services Docker (PAUSE uniquement)
    - name: Pause des services Docker
      shell: docker compose stop
      args:
        chdir: "{{ project_dir }}"
      failed_when: false
      tags: docker

    - name: Pause du service Vault
      shell: docker stop vault || true
      failed_when: false
      tags: docker

    # VÃ©rification des conteneurs
    - name: VÃ©rification des conteneurs
      command: docker ps -a --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: docker_status
      failed_when: false

    # Nettoyage des logs
    - name: Nettoyage logs temporaires
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/backend.log
        - /tmp/frontend.log
      tags: cleanup

    # Confirmation
    - name: Confirmation arrÃªt
      debug:
        msg: |
          âœ… SIT Innovation mis en pause en sÃ©curitÃ© !
          
          ğŸ§¹ Actions effectuÃ©es :
          - Processus Node.js arrÃªtÃ©s
          - Ports 3000 et 4000 libÃ©rÃ©s
          - Services Docker mis en pause (donnÃ©es prÃ©servÃ©es)
          - Logs temporaires supprimÃ©s
          
          ğŸ³ Ã‰tat des conteneurs :
          {{ docker_status.stdout }}
          
          ğŸ”„ RedÃ©marrage : ./launch.sh start
          ğŸ›‘ ArrÃªt complet (avec suppression) : ./launch.sh destroy
      tags: summary
